<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EMİR KAPI TOSYA - Admin Paneli</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
  <link rel="stylesheet" href="Css/Admin page.css">
  <style>
    #product-list { list-style: none; padding-left: 0; }
    #product-list li { margin-bottom: 8px; }
    #product-list button { margin-left: 12px; font-size: .9rem; }
    
    /* New styles for upload functionality */
    .image-upload-container {
      display: flex;
      gap: 20px;
      margin-top: 15px;
    }
    
    .upload-area {
      border: 2px dashed #ccc;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      flex: 1;
    }
    
    .upload-area:hover {
      border-color: #3498db;
      background-color: #f8f9fa;
    }
    
    .upload-icon {
      font-size: 48px;
      color: #3498db;
      margin-bottom: 10px;
    }
    
    .image-preview {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .preview-image {
      max-width: 200px;
      max-height: 200px;
      border-radius: 4px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: none;
    }
    
    .progress-bar {
      height: 6px;
      background: #e0e0e0;
      border-radius: 3px;
      margin-top: 10px;
      overflow: hidden;
      display: none;
    }
    
    .progress-fill {
      height: 100%;
      background: #3498db;
      width: 0%;
      transition: width 0.3s;
    }
    
    .upload-status {
      margin-top: 10px;
      font-size: 14px;
      color: #666;
      display: none;
    }
    
    .upload-success {
      color: #27ae60;
    }
    
    .upload-error {
      color: #e74c3c;
    }
  </style>
</head>
<body>
  <!-- Login Page -->
  <div id="loginPage" class="login-container">
    <div class="login-box">
      <div class="logo"><i class="fas fa-door-open"></i></div>
      <h2><a href="index.html" style="text-decoration: none; color: #2c3e50;"> EMİR KAPI TOSYA Admin Paneli</a></h2>
      <div id="loginAlert" class="admin-alert">Hatalı kullanıcı adı veya şifre!</div>
      <div class="form-group">
        <label for="username">Kullanıcı Adı</label>
        <input type="text" id="username" placeholder="Kullanıcı adınızı girin">
      </div>
      <div class="form-group">
        <label for="password">Şifre</label>
        <input type="password" id="password" placeholder="Şifrenizi girin">
      </div>
      <button id="loginBtn" class="btn">Giriş Yap</button>
    </div>
  </div>
  
  <!-- Admin Dashboard -->
  <div id="adminDashboard" class="admin-dashboard">
    <header class="admin-header">
      <div class="container admin-header-container">
        <div class="admin-logo">
          <i class="fas fa-door-open"></i>
          <h1><a href="index.html">EMİR KAPI TOSYA Admin</a></h1>
        </div>
        <div class="admin-user">
          <span><i class="fas fa-user-shield"></i> Yönetici: Mustafa Emir</span>
          <a href="#" id="logoutBtn" class="logout-btn">
            <i class="fas fa-sign-out-alt"></i> Çıkış Yap
          </a>
        </div>
      </div>
    </header>

    <main class="admin-main container">
      <!-- Existing Products List -->
      <section class="control-group">
        <h2>Mevcut Ürünler</h2>
        <ul id="product-list"></ul>
      </section>

      <!-- Product Form -->
      <h2 class="section-title">Ürün Yönetimi</h2>
      <div class="admin-panel">
        <div class="admin-panel-header">
          <h2><i class="fas fa-cogs"></i> Ürün Ekle / Düzenle</h2>
        </div>
        <div class="admin-controls">
          <div class="control-group">
            <label for="product-name">Ürün Adı</label>
            <input type="text" id="product-name" placeholder="Ürün adını girin">
          </div>
          <div class="control-group">
            <label for="product-price">Fiyat (TL)</label>
            <input type="number" id="product-price" value="0">
          </div>
          <div class="control-group">
            <label for="product-old-price">Eski Fiyat (TL)</label>
            <input type="number" id="product-old-price" value="0">
          </div>
          <div class="control-group">
            <label for="product-features">Özellikler (Her satırda bir özellik)</label>
            <textarea id="product-features" placeholder="Özellikleri girin"></textarea>
          </div>
          
          <!-- Image Upload Section -->
          <div class="control-group">
            <label>Ürün Görseli</label>
            <div class="image-upload-container">
              <div class="upload-area" id="uploadArea">
                <i class="fas fa-cloud-upload-alt upload-icon"></i>
                <p>Resmi sürükleyip bırakın veya tıklayarak seçin</p>
                <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                <div class="progress-bar">
                  <div class="progress-fill"></div>
                </div>
                <div class="upload-status"></div>
              </div>
              <div class="image-preview">
                <img id="previewImage" class="preview-image" alt="Resim önizleme">
              </div>
            </div>
            <div class="control-group" style="margin-top: 15px;">
              <label for="product-image">Veya URL kullanın</label>
              <input type="text" id="product-image" placeholder="https://...jpg">
            </div>
          </div>
        </div>
        <div class="admin-actions">
          <button class="btn save-btn"><i class="fas fa-save"></i> Kaydet</button>
          <button class="btn btn-secondary" id="newProductBtn"><i class="fas fa-plus"></i> Yeni Ürün</button>
          <button class="btn btn-danger" id="deleteProductBtn"><i class="fas fa-trash"></i> Sil</button>
        </div>
      </div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

 <script>
document.addEventListener('DOMContentLoaded', async () => {
  const SUPABASE_URL = 'https://rfqfmouwbvnqjtsdveym.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJmcWZtb3V3YnZucWp0c2R2ZXltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNzkwMzAsImV4cCI6MjA2NzY1NTAzMH0.1Xxnym1R2IXqb7M1fLUcsbInPREBcMmNhiqKeu9VaWg';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  
  // DOM elements
  const loginPage = document.getElementById('loginPage');
  const adminDashboard = document.getElementById('adminDashboard');
  const loginBtn = document.getElementById('loginBtn');
  const loginAlert = document.getElementById('loginAlert');
  const logoutBtn = document.getElementById('logoutBtn');
  const saveBtn = document.querySelector('.admin-actions .save-btn');
  const deleteBtn = document.getElementById('deleteProductBtn');
  const newBtn = document.getElementById('newProductBtn');
  const uploadArea = document.getElementById('uploadArea');
  const imageUpload = document.getElementById('imageUpload');
  const previewImage = document.getElementById('previewImage');
  const progressBar = document.querySelector('.progress-bar');
  const progressFill = document.querySelector('.progress-fill');
  const uploadStatus = document.querySelector('.upload-status');
  const productImageInput = document.getElementById('product-image');

  // Check existing session
  const { data: { session } } = await supabase.auth.getSession();
  if (session) {
    loginPage.style.display = 'none';
    adminDashboard.style.display = 'block';
    renderProducts();
  }

  // Login function
  loginBtn.addEventListener('click', async () => {
    const email = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    
    const { error } = await supabase.auth.signInWithPassword({
      email,
      password
    });

    if (error) {
      loginAlert.style.display = 'block';
      setTimeout(() => loginAlert.style.display = 'none', 3000);
    } else {
      loginPage.style.display = 'none';
      adminDashboard.style.display = 'block';
      renderProducts();
    }
  });

  // Logout function
  logoutBtn.addEventListener('click', async (e) => {
    e.preventDefault();
    await supabase.auth.signOut();
    location.reload();
  });

  // Upload image to Supabase Storage
  async function uploadImage(file) {
    try {
      // Reset UI
      progressBar.style.display = 'block';
      progressFill.style.width = '0%';
      uploadStatus.textContent = 'Yükleniyor...';
      uploadStatus.className = 'upload-status';
      uploadStatus.style.display = 'block';
      
      // Generate unique filename
      const fileName = `${Date.now()}-${file.name.replace(/\s+/g, '-')}`;
      
      // Upload to Supabase Storage
      const { data, error } = await supabase.storage
        .from('product-images')
        .upload(fileName, file, {
          cacheControl: '3600',
          upsert: false,
          onUploadProgress: (progress) => {
            const percent = Math.round((progress.loaded / progress.total) * 100);
            progressFill.style.width = `${percent}%`;
          }
        });

      if (error) throw error;
      
      // Get public URL
      const { data: { publicUrl } } = supabase.storage
        .from('product-images')
        .getPublicUrl(data.path);
      
      // Update UI
      progressFill.style.width = '100%';
      uploadStatus.textContent = 'Yükleme başarılı!';
      uploadStatus.className = 'upload-status upload-success';
      
      return publicUrl;
    } catch (error) {
      console.error('Upload error:', error);
      uploadStatus.textContent = `Hata: ${error.message}`;
      uploadStatus.className = 'upload-status upload-error';
      return null;
    }
  }

  // Upload area event listeners
  uploadArea.addEventListener('click', () => {
    imageUpload.click();
  });
  
  uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.style.borderColor = '#3498db';
    uploadArea.style.backgroundColor = '#f1f8ff';
  });
  
  uploadArea.addEventListener('dragleave', () => {
    uploadArea.style.borderColor = '#ccc';
    uploadArea.style.backgroundColor = '';
  });
  
  uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.style.borderColor = '#ccc';
    uploadArea.style.backgroundColor = '';
    
    if (e.dataTransfer.files.length) {
      handleImageUpload(e.dataTransfer.files[0]);
    }
  });
  
  imageUpload.addEventListener('change', (e) => {
    if (e.target.files.length) {
      handleImageUpload(e.target.files[0]);
    }
  });
  
  async function handleImageUpload(file) {
    if (!file.type.match('image.*')) {
      uploadStatus.textContent = 'Sadece resim dosyaları yüklenebilir!';
      uploadStatus.className = 'upload-status upload-error';
      uploadStatus.style.display = 'block';
      return;
    }
    
    // Show preview
    const reader = new FileReader();
    reader.onload = (e) => {
      previewImage.src = e.target.result;
      previewImage.style.display = 'block';
    };
    reader.readAsDataURL(file);
    
    // Upload to Supabase
    const publicUrl = await uploadImage(file);
    
    if (publicUrl) {
      // Set the URL in the input field
      productImageInput.value = publicUrl;
    }
  }

  async function renderProducts() {
    const { data: products, error } = await supabase
      .from('products')
      .select('*');
    
    if (error) {
      console.error('Error loading products:', error);
      return;
    }

    const list = document.getElementById('product-list');
    list.innerHTML = '';
    
    products.forEach(p => {
      const li = document.createElement('li');
      li.innerHTML = `
        <strong>${p.name}</strong> &mdash; ${p.price} TL
        ${p.oldPrice ? `(Eski: ${p.oldPrice} TL)` : ''}
        <button data-id="${p.id}" class="edit-btn">Düzenle</button>
      `;
      list.appendChild(li);
    });

    document.querySelectorAll('.edit-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const { data: product, error } = await supabase
          .from('products')
          .select('*')
          .eq('id', btn.dataset.id)
          .single();
        
        if (error) return;
        
        document.getElementById('product-name').value = product.name;
        document.getElementById('product-price').value = product.price;
        document.getElementById('product-old-price').value = product.oldPrice || 0;
        document.getElementById('product-features').value = product.features.join('\n');
        document.getElementById('product-image').value = product.imageUrl;
        saveBtn.dataset.editId = product.id;
        
        // Show product image preview
        if (product.imageUrl) {
          previewImage.src = product.imageUrl;
          previewImage.style.display = 'block';
        } else {
          previewImage.style.display = 'none';
        }
      });
    });
  }

  saveBtn.addEventListener('click', async () => {
    const productData = {
      name: document.getElementById('product-name').value,
      price: Number(document.getElementById('product-price').value),
      oldPrice: Number(document.getElementById('product-old-price').value) || null,
      features: document.getElementById('product-features').value
                 .split('\n').map(f => f.trim()).filter(f => f),
      imageUrl: document.getElementById('product-image').value
    };
    

    if (!productData.name) {
      alert('Ürün adı gereklidir!');
      return;
    }

    if (saveBtn.dataset.editId) {
      // Update existing product
      const { error } = await supabase
        .from('products')
        .update(productData)
        .eq('id', saveBtn.dataset.editId);
      
      if (error) alert('Güncelleme hatası: ' + error.message);
    } else {
      // Create new product
      const { error } = await supabase
        .from('products')
        .insert([productData]);
      
      if (error) alert('Ekleme hatası: ' + error.message);
    }
    
    alert('Değişiklikler kaydedildi!');
    delete saveBtn.dataset.editId;
    await renderProducts();
  });

  // UPDATED DELETE FUNCTION WITH IMAGE DELETION
  deleteBtn.addEventListener('click', async () => {
    if (!saveBtn.dataset.editId) {
      alert('Silmek için bir ürün seçin!');
      return;
    }
    
    const confirmDelete = confirm('Bu ürünü silmek istediğinize emin misiniz?');
    if (!confirmDelete) return;
    
    // Fetch product data to get image URL
    const { data: product, error: fetchError } = await supabase
      .from('products')
      .select('imageUrl')
      .eq('id', saveBtn.dataset.editId)
      .single();
    
    if (fetchError) {
      alert('Ürün getirilemedi: ' + fetchError.message);
      return;
    }
    
    // Delete image from storage if exists
    if (product.imageUrl) {
      try {
        const urlParts = product.imageUrl.split('/');
        const fileName = urlParts[urlParts.length - 1];
        
        const { error: storageError } = await supabase.storage
          .from('product-images')
          .remove([fileName]);
        
        if (storageError) {
          console.error('Resim silinemedi:', storageError);
          alert('Resim silinemedi, ancak ürün veritabanından kaldırıldı. Hata: ' + storageError.message);
        }
      } catch (error) {
        console.error('Resim silme işleminde hata:', error);
      }
    }
    
    // Delete product record
    const { error } = await supabase
      .from('products')
      .delete()
      .eq('id', saveBtn.dataset.editId);
    
    if (error) {
      alert('Silme hatası: ' + error.message);
    } else {
      alert('Ürün silindi!');
      resetForm();
      await renderProducts();
    }
  });
  
  newBtn.addEventListener('click', resetForm);
  
  function resetForm() {
    document.getElementById('product-name').value = '';
    document.getElementById('product-price').value = '0';
    document.getElementById('product-old-price').value = '0';
    document.getElementById('product-features').value = '';
    document.getElementById('product-image').value = '';
    previewImage.style.display = 'none';
    progressBar.style.display = 'none';
    uploadStatus.style.display = 'none';
    delete saveBtn.dataset.editId;
  }
});
</script>
</body>
</html>